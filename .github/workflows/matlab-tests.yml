name: MATLAB Tests

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Run MATLAB Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2023b
          # products: (no additional products required - base MATLAB only)
      
      - name: Run static analysis (report mode - never fails)
        uses: matlab-actions/run-command@v2
        with:
          command: |
            cd tests
            static_analysis('Mode', 'CI', 'FailOnIssues', false, 'Verbose', true)
            disp('✓ Static analysis report complete')
      
      - name: Upload static analysis reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: static-analysis-reports
          path: |
            tests/static_analysis_report.json
            tests/static_analysis_report.md
          retention-days: 30
      
      - name: Gate on critical issues
        if: always()
        run: |
          python3 - <<'PY'
          import json, sys, os
          
          json_path = "tests/static_analysis_report.json"
          if not os.path.exists(json_path):
              print("✗ Static analysis report not found")
              sys.exit(1)
          
          with open(json_path) as f:
              data = json.load(f)
          
          crit = data.get("summary", {}).get("critical", 0)
          total = data.get("summary", {}).get("total", 0)
          
          print(f"Static analysis gate: CRITICAL={crit}, TOTAL={total}")
          
          # Fail if critical issues found (can be configured via env var)
          fail_threshold = os.environ.get("STATIC_FAIL_LEVEL", "critical")
          
          if fail_threshold == "critical" and crit > 0:
              print(f"✗ Found {crit} critical issues - failing")
              sys.exit(1)
          elif fail_threshold == "any" and total > 0:
              print(f"✗ Found {total} total issues - failing")
              sys.exit(1)
          else:
              print("✓ Static analysis gate passed")
              sys.exit(0)
          PY
      
      - name: Run all tests
        uses: matlab-actions/run-command@v2
        with:
          command: |
            cd tests
            try
              Run_All_Tests
              disp('✓ All tests passed')
            catch ME
              disp(['✗ Tests failed: ' ME.message])
              exit(1)
            end
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/test_results.mat
          retention-days: 30

  # Separate job for documentation build (optional)
  docs-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Scan README for BROKEN_LINK markers
        run: |
          echo 'Checking README for "BROKEN_LINK" markers...'
          # Basic marker check (expand to real link checking if needed)
          if grep -q "BROKEN_LINK" README.md; then
            echo "✗ Found BROKEN_LINK markers in README"
            exit 1
          fi
          echo "✓ No BROKEN_LINK markers found in README"
      
      - name: Verify notebook exists
        run: |
          if [ ! -f "docs/03_NOTEBOOKS/Tsunami_Vortex_Analysis_Complete_Guide.ipynb" ]; then
            echo "✗ Main notebook missing"
            exit 1
          fi
          echo "✓ Notebook exists"
